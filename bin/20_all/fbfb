#!/usr/bin/env zsh
set -e

OPTIONS=$(getopt -o d:em:p:u:y \
            --long date:,edit,message:,path:,user:,yesterday \
            -n 'fbfb' -- "$@")
eval set -- "$OPTIONS"

WHO=
DATE="now"
MESSAGE=
EDIT_DESIRED=

while true; do
    case "$1" in
        -d|--date)
            DATE="$2"
            shift 2
            ;;

        -e|--edit)
            EDIT_DESIRED=1
            shift
            ;;

        -m|--message)
            MESSAGE="$2"
            shift 2
            ;;

        -p|--path)
            FBFB_PATH="$2"
            shift 2
            ;;

        -u|--user)
            WHO="$2"
            shift 2
            ;;

        -y|--yesterday)
            DATE="yesterday"
            shift
            ;;

        --)
            shift
            break
            ;;

        *)
            break
            ;;
    esac
done

DATE=$(date --date=$DATE +%F)
if [ -z $WHO ]; then
    WHO=$(whoami)
fi

mkdir -p $FBFB_PATH/$WHO

if [ ! -z $EDIT_DESIRED ]; then
    $EDITOR $FBFB_PATH/$WHO/$DATE.md
else
    if [ -z $MESSAGE ]; then
        TEMPFILE=$(mktemp)
        $EDITOR $TEMPFILE
        MESSAGE=$(cat $TEMPFILE)
        rm $TEMPFILE
    fi
    echo $MESSAGE >> $FBFB_PATH/$WHO/$DATE.md
fi
